# 计算机网络(四)：网络层

## 介绍

### 转发和路由选择

网络层的作用看起来很简单，就是把一台主机发送的分组移动到接收分组的机器。其需要如下两种功能。

- **转发**

  路由器必须将分组移动到适当的输出链路

- **路由选择**

  分组在传输的时候，网络层的路由选择算法将决定这些分组采用的路由和路径

### 网络服务模型

对于运输层向网络层传输时所产生的各种问题(连续分组的时间间隔网络层怎么处理；是否反馈网络阻塞信息；...)，可以由网络层提供的服务模型所确定。

- **确保交付**

- **确定时间内交付**

- **有序分组交付**

- **确保最小带宽**

  确定低于带宽的速率传输分组不会丢失

- **确保最大时延抖动**

  发送方的两个相继分组之间的时间量等于接收方它们的时间量(或变化小于某个特定值)

- **安全性服务**

## 虚电路与数据报网络

正如传输层为每个应用提供连接与无连接服务(TCP & UDP)，网络层也提供无连接与有连接服务。在目前世界的网络体系中，网络层只能单一提供其中一种方式，我们将提供连接的服务称为虚电路网络，将提供无连接服务称为数据报网络

### 虚电路网络

仅在网络层提供连接服务的计算机网络

![虚电路](http://qiniu.itliusir.com/%E8%99%9A%E7%BD%91%E7%BB%9C.png)

组成：

1. 源和目的主机之间的路径    

2. VC号(经过路由器会被路由转发表VC替换)

3. 沿着该路径的每台路由器中的转发表表项

阶段：

1. 虚电路建立
2. 数据传送
3. 虚电路拆除

### 数据报网络

![数据报](http://qiniu.itliusir.com/%E6%95%B0%E6%8D%AE%E6%8A%A5%E7%BD%91%E7%BB%9C.png)

仅在网络层提供无连接服务的计算机网络

## 路由器工作原理

如下图在路由器体系结构图

![路由结构](http://qiniu.itliusir.com/%E8%B7%AF%E7%94%B1%E7%BB%93%E6%9E%84.png)

- **输入端口处理**

  ![输入](http://qiniu.itliusir.com/%E8%BE%93%E5%85%A5%E7%AB%AF%E5%8F%A3.png)

- **交换结构**

  如下图为三种交换技术

  ![交换](http://qiniu.itliusir.com/%E4%BA%A4%E6%8D%A2%E6%8A%80%E6%9C%AF.png)

  从输入端口交换到一个输出端口

- **输出端口**

  出路去除存放在输出端口内存中的分组并将其发送到输出链路上

  如下图为输出端口处理

  ![输出](http://qiniu.itliusir.com/%E8%BE%93%E5%87%BA%E7%AB%AF%E5%8F%A3.png)

## IP 协议

### 数据报格式

![数据报格式](http://qiniu.itliusir.com/%E6%95%B0%E6%8D%AE%E6%8A%A5%E6%A0%BC%E5%BC%8F.png)

- *version*

  版本号，不同版本使用不同数据报格式

- *ihl*

  首部长度

- *type of service*

  服务类型

- *total length*

  数据报总长度

- *identification*

  标识

- *flags*

  标志

- *fragment offset*

  片偏移

- *time to live*

  存活时长，每经过一次路由器减一，为零则丢弃

- *protocol*

  协议，在到达目的地时用于指示把值交给哪个传输层，如 为6表示交给TCP ，为17表示交给UDP

- *header checksum*

  首部校验和，将首部中每两个字节作为一个数，用反码对这些数求和，在路由器接收的时候要对每个数据报计算其首部校验和然后和首部携带的校验和对比，不一致则认为是错误，路由器一般会丢弃。需要注意的是IP协议的校验和是只针对首部的，而TCP/UDP的校验和是针对整个报文进行的

#### IP 数据报分片

我们将一个链路层帧能承载的最大数据量叫做 **MTU** (Maximum Transmission Unit, 最大传送单元) ，因为不同链路的MTU都不同。例如在入链路(MTU 1500) 经过路由器到出链路(MTU 500)，解决办法是分片。顾名思义就是将1个大的数据报分为3个较小的数据报，然后向输出链路上发送这些帧，分片到达到目的地传输层以前需要重新组装。

IPv4的设计者们为坚持网络内核保持简单的原则，放弃了把组装工作放到路由器中，而是将其放到了端系统中。为此IPv4的设计者们将标识、标志、偏移量放在IP 数据报首部中，当生成一个数据报时，发送主机对每个发送的数据报的标识加1，然后通过标志是否为0来确定收到了最后一个分片，最后通过偏移量可以计算出该片在数据报的哪个位置。

> example：
>
> 一个4000字节的数据报（20字节IP首部加上3980字节IP有效载荷）到达一台路由器，且必须被转发到一条MTU为1500字节的链路上
>
> ![](http://qiniu.itliusir.com/ip_fragment.png)