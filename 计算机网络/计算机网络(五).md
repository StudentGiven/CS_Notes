# 计算机网络(五)：链路层

在上一节我们了解到了网络层提供的服务和数据报的格式，我们自然而然地想知道网络层的数据报是怎样被封装进链路层帧的呢？又是如何通过各段链路的呢？不同链路采用的也是不同链路层协议吗？

## 介绍

### 帧

每一个网络层的数据报经过链路传送之前，链路层协议都要将其用链路层帧封装起来。一个帧由一个数据字段(网络层数据报)和若干首部字段组成，帧的结构由链路层协议所规定

### MAC (Medium Access Control, 媒体访问控制)协议

该协议规定了帧在链路上传输的规则，对于点对点链路，mac协议比较简单，对于多个节点共享单个广播链路时，MAC 协议用于协调多个结点的帧传输

### 可靠服务

链路层的可靠交付通常用于易产生高差错率的链路，例如无线链路，其目的是本地纠正了一个差错而不是通过运输层或应用层协议迫使进行端到端的数据重传。

### 链路层在何处实现

链路层的主体部分是在网络适配器(Network Adapter)中实现的，网络适配器也称为网络接口卡(Network Interface Card, NIC)。位于网路适配器核心的链路层控制器通常是一个实现了许多链路层服务(帧的封装、链路接入、差错检测等)的专用芯片。因此，链路层控制器的许多功能是用硬件实现的。在90年代后期大部分网络适配器还是物理上分离的卡，但越来越多的网络适配器被综合进主机的主板，即所谓的局域网在主板配置。

![](http://qiniu.itliusir.com/%E7%BD%91%E7%BB%9C%E9%80%82%E9%85%8D%E5%99%A8.png)

## 差错检测和纠正技术

当帧中的一个比特作为1传输时，接收方节点的链路层硬件可能不正确的将其判断为0，这种比特差错是由信号衰减和电磁噪声导致的。所以很多链路层协议提供了一种机制来检测这样的比特差错，例如运输层和网络层也提供了有限的查错检测(校验和)。链路层的差错检测则更为复杂，并且用硬件实现

### 相关技术

- **奇偶校验(parity bit check)**

  通过对数据比特中的数据进行奇偶补齐，来对比收到的数据是否出现差错

  Ex:

  ![](http://qiniu.itliusir.com/%E5%81%B6%E6%A0%A1%E9%AA%8C.png)

  如上图中的偶校验，数据比特有9(奇数)个1，校验比特进行偶数个补齐。这样接收方收到如果是奇数个1则说明出现了差错

- **校验和(Check Sum)**

  把数据的字节作为16比特的整数对待并求和，这个和的反码形成了携带在首部的校验和。当然对比TCP和UDP的校验和，链路层提供了更强的差错保护，使用硬件实现的CRC

- **循环冗余检测(Cyclic Redundancy Check, CRC)**

  CRC编码也被称为多项式编码(polynomial code) , 因为该编码能够将要发送的比特串看作为系数是0和1的一个多项式，对比特串的操作被解释为多项算术。

## 多路访问链路和协议

以太网和无线局域网都是广播链路层的例子，那如何协调多个发送与接收节点对一个共享广播信道的访问，就是接下来要介绍的多路访问协议。

### 信道划分协议

- *时分多路复用*

  把时间划分为**时间帧**，然后把每个时隙分配给N个节点中的其中一个，时隙的长度要保证能够传输单个分组(链路层的帧)

  **优势：** 消除了碰撞，非常公平

  **缺陷：** 速率被限制；节点需要等待它在传输序列的轮次

- *频分多路复用*

  把信道划分为不同的频段，并把每个频率分配给N个节点中的一个

  **优势：** 消除了碰撞，公平的划为了带宽

  **缺陷：** 一个节点只能使用对应频段的带宽

- *码分多址*

  对每一个节点分配一种不同的编码，每个节点用它唯一的编码来对它发送的数据进行编码

  **优势：** 消除了碰撞，可以同时传输；

  **缺陷：** 每个不同接收方的节点需要具备不同的编码

### 随机接入协议

当有碰撞时，发送碰撞的每个节点在重发之前加个等待随机时延。如某个节点等待的时延小于其他节点的时延，则能够无碰撞的重发出去

### 轮流协议

- *轮询*

主节点向节点A发送一个报文，告诉它能发送帧的最大数量。主节点观察信道上没有缺乏信号，说明节点A已经传输完这些帧后，主节点告诉节点B能发送帧的最大数量。通过上述方式，最终主节点以循环的方式轮询了每个节点

**优势：** 消除了碰撞和空的时间间隙

**缺陷：** 主节点有故障，整个信道无法工作；轮询延时

- *令牌传递协议*

把主节点的调节权通过令牌形式散发到所有节点，当一个结点收到令牌时，如果它确实有帧要传输，它发送最大数目的帧数，然后把令牌转发给下一个结点。如节点A收到令牌执行完把其发给节点B

## 交换局域网

### MAC 地址

主机或路由器的网络适配器具有链路层地址，MAC 地址的性质是没有两块适配器具有相同的地址。其原因是IEEE在管理着该MAC地址空间，当一个公司要生产适配器时，IEEE会分配对应地址的前24比特。而且MAC地址走到哪里都不变

### 地址解析协议(Address Resolution Protocol, ARP)

每台主机或路由器在其内存中具有一个ARP table，这张表包含IP地址到MAC地址的映射关系。若ARP table中当前没有该目的主机的表项，发送方则构造一个特殊分组，询问子网上所有其他主机和路由器，注意，这里使用的是MAC的广播地址来发送这个分组。可以脑补下不知道全靠喊的场景

![arp table](http://qiniu.itliusir.com/ARP_table.png)

## 数据中心网络

![](http://qiniu.itliusir.com/%E6%95%B0%E6%8D%AE%E4%B8%AD%E5%BF%83%E7%BD%91%E7%BB%9C.png)



## Web 页面请求的历程

场景：一名学生 Bob 将他的便携机与学校的以太网交换机相连，下载一个Web页面(www.google.com)

1. Bob 的便携机上的操作系统生成一个 `DHCP` 请求报文，然后放入 `DHCP` 服务器的 `UDP` 报文段，该报文段则被放置在一个广播 `IP` 目的地址
2. 路由器接收到该广播，然后运行在路由器的 `DHCP` 服务器以 `CIDR` 块分配 `IP` 地址，并生成包含这个 `IP` 地址以及 `DNS` 服务器的 `IP` 地址、默认网关路由器的 `IP` 地址、子网块的一个 `DHCP ACK` 报文
3. 包含 `DHCP ACK` 的帧由路由器发送给交换机，交换机从通向Bob便携机的输出端口转发
4. Bob便携机收到该帧(`DHCP ACK`)--> `IP` 数据报--> `UDP` 报文段--> `DHCP ACK` 报文，`Bob` 的 `DHCP` 客户端则记录下它的`IP` 地址、`DNS` 服务器的 `IP` 地址、默认网关地址
5. 把 `DNS` 请求报文的数据报放入一个以太网帧中(用于解析Google域名)。发送到Bob学校的网关路由器(第四步从 `ACK` 已拿到网关路由器 `IP` 地址)，还需要通过 `ARP` 获取网关路由器的MAC地址，最终包含 `DNS` 查询的 `IP` 数据报到达 `DNS` 服务器
6. `DNS` 服务抽取出 `DNS` 查询报文，在数据库查找谷歌域名对应的 `IP` 地址，最终Bob便携机准备接触 `www.google.com` 服务器
7. 已拿到对应 `IP` 地址，web浏览器生成 `TCP套接字` ，发送GET 报文，该报文成为一个TCP报文段的 payload，该TCP报文段放置进一个数据报并交付到 `www.google.com`
8. `www.google.com` 的HTTP服务器从TCP套接字读取HTTP GET 报文，生成一个HTTP响应报文，将请求的Web页内容放入HTTP响应体中，并将报文发送进TCP套接字中
9. 包含HTTP 响应的数据报通过谷歌、`DNS` 服务器和学校网络转发，到达Bob便携机，Bob终于看到 Google界面啦！