# 计算机网络(三)：传输层

## 介绍

传输层位于应用层与网络层之间，为两个进程之间提供服务。

### 运作模式

接受网络层的服务，向应用层提供服务。

![](http://qiniu.itliusir.com/3.1%20%E4%BC%A0%E8%BE%93%E5%B1%82%E7%9A%84%E9%80%BB%E8%BE%91%E8%BF%9E%E6%8E%A5.png)

### 与网络层区别

网络层：负责主机到主机通信，负责把信息报文传送到目的计算机

 传输层：负责进程到进程通信，负责把信息报文传送到正确进程

![](http://qiniu.itliusir.com/3.2.png)

### 端口号

定义：我们使用ip地址来定义本地的主机或远程主机，为了定义进程，需要端口号作为第二标识。在 TCP/IP协议，端口号是在 0到 65 535 的 16位整数。 如下图客户端进程可以使用 52 000 表示自己，但服务器进程必须使用熟知或永久端口号 13。

![](http://qiniu.itliusir.com/3.3.png)

### ICANN范围

`ICANN` 已将端口号分为三种范围：熟知、注册、动态

![](http://qiniu.itliusir.com/3.4.png)

熟知端口：0-1023，由 `ICANN` 分配和控制

注册端口：1024-29151，`ICANN` 不分配不控制，可以注册在 `ICANN` 防止重复

动态端口：不受 `ICANN` 控制，也无需注册，属于临时或私有端口

### 套接字地址

在TCP协议簇中传输层协议需要ip和端口，一个ip和一个端口组合成为套接字地址。由套接字地址来定义进程。

### 封装与解封装

报文的发送端进行封装，传输层将数据加入传输层头部，我们将传输层有效载荷成为分组。

解封装发生在接收端，当包围到达目的传输层，头部被丢弃，传输层将报文传输到应用层运行的进程。

![](http://qiniu.itliusir.com/3.5.png)

### 多路复用与多路分解

从多个源接收数据项时称为多路复用，将数据项传递到多个源时称为多路分解。源端的传输层执行复用，目的端的传输层执行分解

![复用与分解](http://qiniu.itliusir.com/%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8.png)



客户端的传输层接收到P1~P3三个进程的m1~m3的三个报文并创建三个分组(复用)

服务端1的传输层将报文m1、m3分发到两个不同的进程P1、P3，服务端2的传输层将报文m2分发到进程P2(分解)

### 流量控制

#### 传输层流量控制

对于发送方传输层来说有两个作用：

1. 消费应用层发来的报文
2. 封装进分组并传递给接收方的传输层

对于接收方传输层也有两个作用：

1. 消费从发送方那里接收的分组
2. 解封装报文并传递给应用层

所以我们至少需要两种流量控制：发送方**应用层到传输层**的流量控制和**接收方传输层到发送方传输层**的流量控制

![传输层流量控制](http://qiniu.itliusir.com/%E4%BC%A0%E8%BE%93%E5%B1%82%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6.png)



#### 缓冲区

通常流量控制采用的是缓冲区。

当发送方传输层的缓冲区已满，则通知应用层停止给自己传输报文块，当有空闲位置时，通知应用层继续传。

当接收方传输层的缓冲区已满，它就通知发送方传输层停止传输分组，当有空闲位置时，它通知发送方传输层可以再次传输分组。

### 差错控制

在第二节我们简单提到了，网络层的IP协议是不可靠的，而应用层需要可靠性，我们需要把传输层变得可靠。

我们可以通过在传输层加入差错控制服务来实现，差错控制负责以下几点：

1. 丢弃被破坏的分组
2. 丢失和丢弃的分组重传
3. 识别重复分组并丢弃
4. 缓存断序的分组直到丢失的到达

#### 序号

通过加入分组的序号，我们就可以知道哪个分组是重复的，哪个分组是断序的。

#### 确认

接收方为每一组正确到达的分组发送一个确认(ACK)，发送方可以在每次发送时开启一个计时器，如果ACK在计时器超时之前没有到达，发送方就重发这个分组。而如果接收方收到重复的分组则丢弃。对于断序的可以被丢弃也可以缓存直到丢失的分组到来

### 流量和差错控制的结合

我们将流量控制的缓冲区和差错控制的序号/确认号，结合为带序号的缓冲区。

在发送端 ，分组准备发送时使用缓冲区下一个空闲位置号码x作为分组序号；分组x已发送时，其备份存储在内存地址位置x，等待另一端确认。当确认到达时，分组被清除，内存位置空闲出来。

在接收端，当分组y到达时，它被存储在内存位置y上，直到应用层准备好接收它，这时发送一个确认y到达。

#### 滑动窗口

- **发送方**

  ![](http://qiniu.itliusir.com/%E5%8F%91%E9%80%81%E6%96%B9%E6%BB%91%E7%AA%97.png)

  发送窗口本身是一种抽象概念，我们定义三个变量来定义它任何时候的大小和位置：

  1. S0 发送未完成分组窗口
  2. S1 等待接收应用层，待发送分组窗口
  3. S2 发送窗口大小

- **接收方**

  ![](http://qiniu.itliusir.com/%E6%8E%A5%E6%94%B6%E6%96%B9%E6%BB%91%E7%AA%97.png)

  

## 传输层协议

![](http://qiniu.itliusir.com/%E5%8D%8F%E8%AE%AE.png)

### 用户数据报协议 (User Datagram Protocol,UDP)

- **无连接**

  如DNS，它使用UDP，因为客户端向服务端发送一个很短的请求，并接收快速响应。请求和响应可以填充一个用户数据报，因此无连接不是问题。

  如SMTP，它不能使用UDP，因为它在邮件中使用，用户可能发送较长的报文，需要被分割为不同的数据报，在无连接下可能会产生失序问题。而且对于SMTP协议，用户不是需求很快的响应。

- **缺乏差错控制**

  UDP 不提供差错控制。因为其在某些需要可靠的场景是不适用的，如：下载文件、查看文件

  而某些场景则是适用的，如：视频帧的传输

- **缺乏拥塞控制**

- **应用**
  1. 简单的请求-响应
  2. 具有内部流量控制和差错控制的进程，如TFTP
  3. 多播
  4. 管理进程
  5. 路由选择更新协议
  6. 实时应用

### 传输控制协议(Transmission Control Protocol,TCP)

- **流传递**

- **全双工通信**

- **多路复用&多路分解**

- **面向连接的服务**

- **可靠的服务**

  1. 字节序号：TCP在0-2的32次方-1之间随机生成一个数字，如随机数是8888 有4000个字节，被分为4个段，每个段携带1000个字节

     段1：8888(8888-9887)

     段2：9888(9888-10887)

     段3：10888(10888-11887)

     段4：11888(11888-12887)

  2. 确认号：每一方除了使用序号表明携带的第一个字节序号，还使用确认号来确认它收到的字节，这个是累积的，直到完整接收到最后一个字节的序号然后+1作为确认号(对方下一个要发送的序号)

#### 段(segment)

![](http://qiniu.itliusir.com/segment.png)

- **头部**

  若没有选项，默认头部是20个字节，若有则最大60个字节

- **源端口地址**

- **目的端口地址**

- **序号**

- **确认号**

- **控制标记**

  ![](http://qiniu.itliusir.com/control_mark.png)

- **窗口大小**

  长度16位，最大长度是65535个字节，通常由接收方确认，发送方需要根据接收方来动态调整

- **校验和**

  UDP可选，TCP强制

- **紧急指示符**

- **选项**

  可选信息

