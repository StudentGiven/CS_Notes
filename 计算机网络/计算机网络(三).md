# 计算机网络(三)：传输层

## 介绍

传输层位于应用层与网络层之间，为两个进程之间提供服务。

### 运作模式

接受网络层的服务，向应用层提供服务。

![](http://qiniu.itliusir.com/3.1%20%E4%BC%A0%E8%BE%93%E5%B1%82%E7%9A%84%E9%80%BB%E8%BE%91%E8%BF%9E%E6%8E%A5.png)

### 与网络层区别

网络层：负责主机到主机通信，负责把信息报文传送到目的计算机

 传输层：负责进程到进程通信，负责把信息报文传送到正确进程

![](http://qiniu.itliusir.com/3.2.png)

### 端口号

定义：我们使用ip地址来定义本地的主机或远程主机，为了定义进程，需要端口号作为第二标识。在 TCP/IP协议，端口号是在 0到 65 535 的 16位整数。 如下图客户端进程可以使用 52 000 表示自己，但服务器进程必须使用熟知或永久端口号 13。

![](http://qiniu.itliusir.com/3.3.png)

### ICANN范围

`ICANN` 已将端口号分为三种范围：熟知、注册、动态

![](http://qiniu.itliusir.com/3.4.png)

熟知端口：0-1023，由 `ICANN` 分配和控制

注册端口：1024-29151，`ICANN` 不分配不控制，可以注册在 `ICANN` 防止重复

动态端口：不受 `ICANN` 控制，也无需注册，属于临时或私有端口

### 套接字地址

在TCP协议簇中传输层协议需要ip和端口，一个ip和一个端口组合成为套接字地址。由套接字地址来定义进程。

### 封装与解封装

报文的发送端进行封装，传输层将数据加入传输层头部，我们将传输层有效载荷成为分组。

解封装发生在接收端，当包围到达目的传输层，头部被丢弃，传输层将报文传输到应用层运行的进程。

![](http://qiniu.itliusir.com/3.5.png)

### 多路复用与多路分解

从多个源接收数据项时称为多路复用，将数据项传递到多个源时称为多路分解。源端的传输层执行复用，目的端的传输层执行分解

![复用与分解](http://qiniu.itliusir.com/%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8.png)



客户端的传输层接收到P1~P3三个进程的m1~m3的三个报文并创建三个分组(复用)

服务端1的传输层将报文m1、m3分发到两个不同的进程P1、P3，服务端2的传输层将报文m2分发到进程P2(分解)

### 流量控制

#### 传输层流量控制

对于发送方传输层来说有两个作用：

1. 消费应用层发来的报文
2. 封装进分组并传递给接收方的传输层

对于接收方传输层也有两个作用：

1. 消费从发送方那里接收的分组
2. 解封装报文并传递给应用层

所以我们至少需要两种流量控制：发送方**应用层到传输层**的流量控制和**接收方传输层到发送方传输层**的流量控制

![传输层流量控制](http://qiniu.itliusir.com/%E4%BC%A0%E8%BE%93%E5%B1%82%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6.png)



#### 缓冲区

通常流量控制采用的是缓冲区。

当发送方传输层的缓冲区已满，则通知应用层停止给自己传输报文块，当有空闲位置时，通知应用层继续传。

当接收方传输层的缓冲区已满，它就通知发送方传输层停止传输分组，当有空闲位置时，它通知发送方传输层可以再次传输分组。

### 差错控制

在第二节我们简单提到了，网络层的IP协议是不可靠的，而应用层需要可靠性，我们需要把传输层变得可靠。

我们可以通过在传输层加入差错控制服务来实现，差错控制负责以下几点：

1. 丢弃被破坏的分组
2. 丢失和丢弃的分组重传
3. 识别重复分组并丢弃
4. 缓存断序的分组直到丢失的到达

#### 序号

通过加入分组的序号，我们就可以知道哪个分组是重复的，哪个分组是断序的。

#### 确认

接收方为每一组正确到达的分组发送一个确认(ACK)，发送方可以在每次发送时开启一个计时器，如果ACK在计时器超时之前没有到达，发送方就重发这个分组。而如果接收方收到重复的分组则丢弃。对于断序的可以被丢弃也可以缓存直到丢失的分组到来

