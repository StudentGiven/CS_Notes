# 操作系统(一)：计算机系统漫游

## hello 程序的生命周期

在 Unix 系统上，从源文件到目标文件的转化是由编译器驱动程序完成的

*vim hello.c*

```c
#include <stdio.h>

int main()
{
    printf("hello, world\n");
    return 0;
}
```

*gcc -o hello hello.c*

```shell
liugangdeMacBook-Pro:c liugang$ ll
total 32
drwxr-xr-x  4 liugang  wheel   128  9  1 21:04 ./
drwxrwxrwx+ 5 root     wheel   160  9  1 21:02 ../
-rwxr-xr-x  1 liugang  wheel  8432  9  1 21:04 hello*
-rw-r--r--  1 liugang  wheel    79  9  1 21:03 hello.c
```

GCC 编译器驱动程序把源文件.c翻译成可执行目标文件 hello

其翻译过程可分为如下四个阶段完成

![](http://qiniu.itliusir.com/gcc_process.png)

- **预处理**

  读取#开头的系统头文件，将其插入程序文本中，得到 hello.i

- **编译阶段**

  将 hello.i 翻译成汇编文本文件 hello.s

- **汇编阶段**

  把 hello.s 翻译成机器语言指令，并把这些指令打包成 *可重定位目标程序* 的格式，把结果保存在 hello.o 中

  ```shell
  liugangdeMacBook-Pro:c liugang$ gcc -c hello.c -o hello.o && nm hello.o
  0000000000000000 T _main
                   U _printf
  ```

  最左边的一列是变量的相对地址(不同段的相对地址有可能是相同的)，中间的一列表示变量所在的段的类型(T 表示代码段)，右面表示变量的名字。

- **链接阶段**

  如 hello.c 文件中调用了 printf 函数，它存在于一个名为 printf.o 的目标文件中，链接器负责把 printf.o 合并到 hello.o 程序中，得到可执行目标文件 hello

> **hello 执行流程**
>
> - 读取
>
>   shell 把要运行的hello读入寄存器，再放到内存。
>
> - 加载
>
>   当敲击回车执行时，shell 加载可执行 hello 文件，把目标执行文件的代码和数据从磁盘复制到主存(可使用直接存储器存取DMA不通过处理器把磁盘复制到主存)
>
> - 回显
>
>   可执行目标文件的代码和数据被加载到主存后，处理器开始执行hello程序的main程序的机器指令，把输出字符串字节从主存复制到寄存器再从寄存器复制到显示设备，最后在屏幕上显示 hello, world

## 系统的硬件组成

### 总线

贯穿整个系统的一组电子管道，它携带信息字节并负责在各个部件间传递

### I/O 设备

系统与外界的通道，例如键盘、鼠标、显示器、磁盘都属于 I/O 设备。每个 I/O 设备都通过一个控制器(通常是主板上的芯片组)或适配器(插在主板插槽的卡)与 I/O 总线相连。

### 主存

它是由一组 *动态随机存取存储器*(DRAM) 组成的，用来暂存指令以及处理器计算的结果等。

### 处理器

用于执行主存中指令，核心是一个大小为一个字的 PC寄存器 ，任何时刻，该寄存器都指向主存中某条机器语言指令。

## 高速缓存

根据机械原理，较大的存储设备要比较小的存储设备运行的慢，而快速设备的造价远高于同类的低速设备。

针对不同设备之间的性能差异，设计者采用更小更快的存储设备来存放高速设备可能需要的信息(局部性原理)，通过缓存来提高性能。

![](http://qiniu.itliusir.com/RAM.png)

## 操作系统(硬件管理者)

由上文中的 可执行目标程序 hello，可以看出在整个流程中都没有直接访问键盘 显示器 主存，取而代之的是他们依靠操作系统提供的服务。

![](http://qiniu.itliusir.com/system3.png)

操作系统通过**进程** **虚拟内存** **文件** 来实现硬件控制与不同设备的抽象

![](http://qiniu.itliusir.com/system2.png)

文件是对 I/O 设备的抽象，虚拟内存是对主存和 I/O 设备的抽象，进程是对处理器、主存和 I/O 设备的抽象

### 进程

进程是操作系统对一个正在运行程序的抽象，在一个系统上可以同时运行多个进程。这是通过处理器在进程间切换(上下文切换)来实现的

上下文包括如 PC 寄存器的当前值，主存的内容等。下面是一个上下文切换的流程。

![](http://qiniu.itliusir.com/context.png)

### 虚拟内存

虚拟内存是一个抽象概念，它为每个进程都提供了自己独占的使用内存的假象。每个进程看到的内存称为虚拟地址空间，如下所示。

![](http://qiniu.itliusir.com/virtual_address.png)

### 文件

文件就是字节序列，一切皆文件。

这样抽象的好处是向应用程序提供了统一视图，程序员无须了解具体磁盘技术，同一个应用程序可以使用不同磁盘技术在不同系统上运行。

## Amdahl 定律

该定律思想是：我们对系统某部分优化时，其对系统整体性能的影响取决于该部分的重要性和加速程度。

设执行时长为T1，某部分执行时间与与该时间比例为α，该部分性能提升比例为k。总的执行时间T2应为：

T2 = (1-α)T1 + (αT1)/k = T1[(1-α) + a/k]

推导出加速比S=T1/T2为：

S = 1/[(1-α) + α/k]





