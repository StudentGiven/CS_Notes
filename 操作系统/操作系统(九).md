# 操作系统(九)：虚拟内存

系统中进程之间是共享内存的，如果一个进程不小心写到别的进程使用的内存，就会产生令人迷惑的错误。

为了更好地管理内存并且少出错，现代系统提供了一种对 **内存的抽象** ，叫 **虚拟内存(VM)** 。

它为每个进程提供了一个很大，一致和私有的地址空间。

- 它把主存看成一个存储在磁盘的地址空间的高速缓存，在真实的主存中只保存活动区域，并根据需要在磁盘和主存之间来回传送数据，高效的使用了主存；
- 它为每个进程提供了一致的地址空间，每个进程不需要关心物理内存地址的编排，简化了内存管理；
- 保护每个进程的地址空间不被其他进程破坏。

本文前半篇描述虚拟内存是如何工作的，后半部分描述应用程序如何使用和管理虚拟内存。

## 物理和虚拟寻址

### 物理寻址

主存被组织一个由M个连续字节大小的单元组成的数组，每个字节都有一个唯一的物理地址，如第一个字节地址是0，第二个是1，第三个是2 。我们把这种最自然的方式称为物理寻址。

### 虚拟寻址

现代处理器使用的是虚拟寻址的寻址形式，CPU 通过生成一个虚拟地址来访问主存，这个虚拟地址在被送到内存之前先转换成适当的物理地址(地址翻译)，地址翻译需要内存管理单元MMU(CPU硬件) 和 利用放在主存中的查询表来动态翻译虚拟地址(操作系统管理)

## 地址空间

地址空间是一个非负整数地址的有序集合，主存中的每个字节都有一个选自虚拟地址空间的虚拟地址和一个选自物理空间的物理地址

## 虚拟内存作为缓存的工具

从概念上讲，虚拟内存被组织为一个由存放在磁盘上的N个连续的字节大小的数组，每个字节都有一个唯一的虚拟地址。磁盘上数组的内容被缓存到主存中，磁盘上的数据被分割为块，这些块作为磁盘和主存之间的传输单元，系统通过将虚拟内存分割为虚拟页(大小固定的块)来处理。类似的物理内存也被分割为物理页。

虚拟内存有以下三个状态：

- **未分配的** 系统还未分配的页，没有任何数据和它们关联，不占用磁盘空间(未缓存)
- **缓存的** 当前已缓存在物理内存中的已分配的页(已分配，已缓存)
- **未缓存的** 未缓存在物理内存中的已分配的页(已分配，未缓存)

![vp && pp](http://qiniu.itliusir.com/vp_pp.png)

### DRAM缓存

SRAM 缓存表示位于CPU和主存之间的L1、L2、L3的高速缓存，DRAM 缓存表示虚拟内存系统的缓存，它在主存中 **缓存虚拟页** 

### 页表

页表可以理解一个表，里面每一条都包含了有效位和物理页号或者磁盘地址。

有效位用来表明该页是否被缓存在 DRAM 中。

- **已缓存** 如果设置了有效位，那后面的地址字段就表示 DRAM 中相应物理页的起始位置
- **未缓存** 如果没有设置有效位，并且后面地址字段还不为空则这个地址指向虚拟页在磁盘的起始位置
- **未分配** 如果既没有设置有效位地址字段还为空则表示这个虚拟页还未被分配

![page table](http://qiniu.itliusir.com/page_table.png)

> 由上面的页表结构就可以很清晰的知道如何读取字节了。
>
> 例如CPU想要读取包含在虚拟内存的 VP2，地址翻译硬件将虚拟地址作为索引找到了该页的条目，发现有效位已设置，地址翻译硬件就知道是已缓存了，那么就用其地址字段的物理地址来构造这个字的物理地址。

