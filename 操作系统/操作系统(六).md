# 操作系统(六)：存储器层次结构

在我们的计算机系统模型中，存储器系统是一个线性的字节数组，而CPU则可以常数时间内访问每个存储器的位置。

实际上存储器系统是一个具有不同容量、成本和访问时间的存储设备的层次结构：从高速缓存到慢速磁盘。

## 存储技术

#### 随机访问存储器(Random Access Memory，RAM)

RAM 分为两类，静态的和动态的。静态 RAM (SRAM) 比动态 RAM (DRAM)更快，价格也更贵。SRAM 用来作为高速缓存存储器，DRAM 通常用来作为内存以及图形系统的帧缓冲区。

> **总线** 是一组并行的导线，能携带地址、数据和控制信号。数据和地址可以共享也可以使用不同的，多个设备也可以共享同一条总线。

### 主存

如下指令操作会把地址A的内容加载到寄存器 %rax 中，那其底层流程是什么呢？

```shell
movq A, %rax
```

首先CPU 将 地址 A 放到系统总线上，I/O 桥将信号传递到内存总线，接下来主存从内存总线读地址，从DRAM取出数据字，将数据写到内存总线，I/O 桥将内存总线信号翻译成系统总线信号，最后传递到让CPU读数据，并把数据复制到寄存器%rax

![](http://qiniu.itliusir.com/loadmem.png)

## 磁盘

磁盘是由盘片构成的，每个盘片有两面，表面覆盖着磁性记录材料，盘片中央是一个可以旋转的轴，以固定的旋转速率旋转，如5400转每分钟。

![](http://qiniu.itliusir.com/disk.png)

- **寻道时间** 传动臂首先将读写头定位到目标扇区的磁道上，而移动传动臂所需的时间称为寻道时间
- **旋转时间** 当读写头定位到了期望的磁道，需要等待目标扇区的第一个*位* 旋转到读写头下，这个步骤性能以来读写头到达目标扇区的位置以及磁盘读写的速度
- **传送时间** 驱动器读取目标扇区的内容，此时间依赖于旋转速度和每条磁道的扇区数目

#### 逻辑磁盘块

现代磁盘构造太复杂，为了对操作系统隐藏这样的复杂性，现代磁盘将它们构造呈现为一个简单视图，磁盘封装中有一个小的设备称为磁盘控制器，维护着逻辑块号和实际磁盘扇区之间的映射关系<逻辑块号,(盘面，磁道，扇区)三元组标识的物理扇区>。

### 固态硬盘

基于闪存的存储技术，一个SSD 封装由一个或多个闪存芯片和闪存翻译层组成，闪存芯片替代传统旋转磁盘中的机械驱动器，闪存翻译则是一个硬件设备，扮演着磁盘控制器相同的角色，起到了映射翻译的作用。

![](http://qiniu.itliusir.com/ssd.png)

> 随机写慢的原因主要有里两个，一是擦除块的时间，二是修改一个包含已有数据的页会发生数据页复制

## 局部性

概论：局部性通常有两种不同的形式：时间局部性和空间局部性。一般而言，有良好局部性的程序比局部性差的程序运行的更快。

### 对程序数据引用的局部性

一个具有良好布局的程序

```c
int sumvec(int v[N]){
	int i;sum = 0;
	for(i=0;i<N;i++){
		sum+=v[i];
	}
  return sum;
}
```

变量sum在每次循环迭代中被引用一次，因此具有良好的时间步局性，因为是标量 所以北邮空间布局性。像sumvec这样顺序的访问每一个向量每个元素的函数，具有步长为1的引用模式（顺序引用模式）

### 	取指令的局部性	

因为程序指令是放在内存中的，cpu必须读出这些指令。

代码区别于程序数据的一个重要属性是在运行时 他是不能被修改的，cpu很少会重写或修改这些指令。

> 重复引用相同变量的程序有良好的局部性
>
> 对于步长为k的引用模式的程序，步长越小，空间局部性越好
>
> 对于指令来说，循环有好的时间和空间局部性，循环体越小，循环迭代次数越多，局部性越好

## 存储器层次结构

- **存储技术** 不同存储技术的的时间访问差异很大，速度较快的技术每字节成本较高，而容量较小

- **计算机软件** 一个良好的程序倾向于展示出良好的局部性

### 存储器层次结构中的缓存

**思想：**层次结构中的每一层缓存来自较低的一层的数据对象。

- **缓存命中** 当程序需要第k+1层的某个数据对象d时，它首先在当前存储子在第k层的一个块中查找d。如果d刚好存储在k层中，称之为缓存命中。

- **缓存不命中** 以上情况反之为缓存不命中，选择覆盖现存的一个块，以此选择一种替换策略，如LRU（最近最少被使用）

- **缓存不命中种类**  强制不命中、冷不命中等，只要发生了不命中，第k层的缓存就必须执行某个放置策略。

​		强制不命中、冷不命中等，只要发生了不命中，第k层的缓存就必须执行某个放置策略。

- **缓存管理** 将缓存划分成块，在不同的层之间传递块，判定命中还是不命中，并处理它们

> 基于缓存的存储器层次结构行之有效，是因为较慢的存储设备比较快的存储设备更便宜，因为程序倾向于展示局部性。